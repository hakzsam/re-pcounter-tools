.. _gt215-gpu-hw-events-config:

=======================================
GT215 GPU Hardware events configuration
=======================================

.. contents::

Global counters
===============

All the following hardware events use QUAD counting mode.

PCOUNTER domain 1
-----------------

- trailer: 0xec

- gpu_busy

  - mode: SIMPLE
  - event_src: 0xcb

- input_assembler_busy/vertex_attribute_count

  - mode: SIMPLE
  - event_src: 0x48495a5b/0xf888
  - PGRAPH.VFETCH.UNK0C: 0x1

- input_assembler_waits_for_fb

  - mode: SIMPLE
  - event_src: 0x51
  - PGRAPH.VFETCH.UNK0C: 0x1

- geom_vertex_in_count

  - mode: EVENT_B4
  - start_src: 0xec565554/0xffff
  - event_src: 0xecececec/0x5555
  - PGRAPH.VFETCH.UNK0C: 0x0

- geom_primitive_in_count

  - mode: SIMPLE
  - event_src: 0x4e
  - PGRAPH.VFETCH.UNK0C: 0x1

- geom_vertex_out_count

  - mode: SIMPLE
  - event_src: 0x85

- geom_primitive_out_count

  - mode: SIMPLE
  - event_src: 0x84

- stream_out_busy

  - mode: SIMPLE
  - event_src: 0xecec8786/0x8888

- setup_primitive_count

  - mode: SIMPLE
  - event_src: 0xe0

- setup_primitive_culled_count

  - mode: SIMPLE
  - event_src: 0xb2

- setup_point_count

  - mode: SIMPLE
  - event_src: 0xece7e6e1/0x8080

- setup_line_count

  - mode: SIMPLE
  - event_src: 0xece7e6e2/0x8080

- setup_triangle_count

  - mode: SIMPLE
  - event_src: 0xece7e6e3/0x8080

- rasterizer_tiles_killed_by_zcull_count

  - mode: EVENT_B6
  - start_src: 0x0a090807/0xffff
  - event_src: 0x0c0becec/0x5555
  - PGRAPH.ZCULL.PM_UNKA4: 0x7

- rasterizer_tiles_in_count

  - mode: EVENT_B6
  - start_src: 0x0a090807/0xffff
  - event_src: 0x0c0becec/0x5555
  - PGRAPH.ZCULL.PM_UNKA4: 0x0

PCOUNTER domain 2
-----------------

- trailer: 0xcc


GEOM signals
============

The geom_waits_for_shader signal depends of MP counters.

+------------------------------+----------+-----------------+-----------------+----------------------+----------+
|                              |   CTRL   |      START      |      EVENT      |         MPC          |   MUX    |
+--------------------------+---+----------+----------+------+----------+------+--------------+-------+----------+
| signal                   |SET| CTR_MODE |    SRC   |  OP  |    SRC   |  OP  | PM_GROUP_SEL | UNK40 | 0x400c0c |
+==========================+===+==========+==========+======+==========+======+==============+=======+==========+
| geom_busy                | 3 |  SIMPLE  |    N/A   | N/A  |0x05040100|0xf888|  0x523e2a16  |  0x1  |    N/A   |
+--------------------------+---+----------+----------+------+----------+------+--------------+-------+----------+
| geom_waits_for_shader    | 3 |  SIMPLE  |    N/A   | N/A  |0x05040100|0x22f2|  0x523e2a16  |  0x1  |    N/A   |
+--------------------------+---+----------+----------+------+----------+------+--------------+-------+----------+

VS signals
==========

.. _vs-todo:
TODO
----

- vertex_shader_busy
- vertex_shader_instruction_rate

GS signals
==========

.. _gs-todo:
TODO
----

- geometry_shader_busy
- geometry_shader_instruction_rate

PS signals
==========

.. _ps-todo:
TODO
----

- pixel_shader_busy
- pixel_shader_instruction_rate


SHADER signals
==============

The shader_busy, shader_waits_for_geom and shader_waits_for_rop signals depends
of MP counters.

+------------------------------+----------+-----------------+----------------------+
|                              |   CTRL   |      EVENT      |         MPC          |
+--------------------------+---+----------+----------+------+--------------+-------+
| signal                   |SET| CTR_MODE |    SRC   |  OP  | PM_GROUP_SEL | UNK40 |
+==========================+===+==========+==========+======+==============+=======+
| shader_busy              | 3 |  SIMPLE  |0x208c0400|0xfefe|  0x503c2814  |  0x1  |
+--------------------------+---+----------+----------+------+--------------+-------+
| shader_waits_for_texture | 3 |  SIMPLE  |0x01000302|0x22f2|  0x503c2801  |  0x1  |
+--------------------------+---+----------+----------+------+--------------+-------+
| shader_waits_for_geom    | 3 |  SIMPLE  |0x07060302|0x22f2|  0x523e2a16  |  0x1  |
+--------------------------+---+----------+----------+------+--------------+-------+
| shader_waits_for_rop     | 3 |  SIMPLE  |0x2c2c0100|0x2222|  0x523e2a00  |  0x1  |
+--------------------------+---+----------+----------+------+--------------+-------+

RASTER signals
==============

The shaded_pixel_count signal uses 3 passes to compute its counter value. For
each pass, it uses a different mux for the register 0x408750. These values are
0x8000001c, 0x8000001d and 0x80000003.

.. _raster-todo:
TODO
----

- Find out how shaded_pixel_count is computed
- Find out how rasterizer_pixels_out_count is computed

+--------------------------------------------+----------+-----------------+-----------------+----------+----------+
|                                            |   CTRL   |      START      |      EVENT      |   MUX    |    MUX   |
+----------------------------------------+---+----------+----------+------+----------+------+----------+----------+
| signal                                 |SET| CTR_MODE |    SRC   |  OP  |    SRC   |  OP  | 0x408750 | 0x402ca4 |
+========================================+===+==========+==========+======+==========+======+==========+==========+
| shaded_pixel_count_0                   | 2 |  SIMPLE  |    N/A   |  N/A |0xcc020100|0x0404| see above|    N/A   |
+----------------------------------------+---+----------+----------+------+----------+------+----------+----------+
| shaded_pixel_count_1                   | 2 | EVENT_B6 |0x03020100|0xffff|0x0504cc07|0xaaaa| see above|    N/A   |
+----------------------------------------+---+----------+----------+------+----------+------+----------+----------+
| rasterizer_pixels_out_count_0          | 2 |  SIMPLE  |    N/A   |  N/A |0xcccc0607|0x8888|0x80000016|    N/A   |
+----------------------------------------+---+----------+----------+------+----------+------+----------+----------+
| rasterizer_pixels_out_count_1          | 2 | EVENT_B6 |0x03020100|0xffff|0x0504cc07|0xaaaa|0x80000016|    N/A   |
+----------------------------------------+---+----------+----------+------+----------+------+----------+----------+

ROP signals
===========

rop_samples_in_count = rop_samples_in_count_1 / rop_samples_in_count_0

+----------------------------------------+----------+-----------------+-----------------+----------+----------+----------+
|                                        |   CTRL   |       START     |      EVENT      |   MUX    |   MUX    |   MUX    |
+------------------------------------+---+----------+----------+------+----------+------+----------+----------+----------+
| signal                             |SET| CTR_MODE |    SRC   |  OP  |    SRC   |  OP  | 0x408750 | 0x407008 | 0x40708c |
+====================================+===+==========+==========+======+==========+======+==========+==========+==========+
| rop_busy                           | 2 |  SIMPLE  |    N/A   |  N/A |0x05040302|0xf888|0x80000000|    N/A   |   N/A    |
+------------------------------------+---+----------+----------+------+----------+------+----------+----------+----------+
| rop_waits_for_fb                   | 2 |  SIMPLE  |    N/A   |  N/A |0x7e7f6667|0x22f2|    N/A   |0x80000001|0x80000001|
+------------------------------------+---+----------+----------+------+----------+------+----------+----------+----------+
| rop_waits_for_shader               | 2 |  SIMPLE  |    N/A   |  N/A |0xcccc0706|0x2222|0x80000000|    N/A   |   N/A    |
+------------------------------------+---+----------+----------+------+----------+------+----------+----------+----------+
| rop_samples_killed_by_earlyz_count | 2 | EVENT_B6 |0x03020100|0xffff|0x0504cc07|0xaaaa|0x8000001a|    N/A   |   N/A    |
+------------------------------------+---+----------+----------+------+----------+------+----------+----------+----------+
| rop_samples_killed_by_latez_count  | 2 | EVENT_B6 |0x03020100|0xffff|0x0504cc07|0xaaaa|0x8000001b|    N/A   |   N/A    |
+------------------------------------+---+----------+----------+------+----------+------+----------+----------+----------+
| rop_samples_in_count_0             | 2 |  SIMPLE  |    N/A   |  N/A |0xcccc0607|0x8888|0x80000015|    N/A   |   N/A    |
+------------------------------------+---+----------+----------+------+----------+------+----------+----------+----------+
| rop_samples_in_count_1             | 2 | EVENT_B6 |0x03020100|0xffff|0x0504cc07|0xaaaa|0x80000015|    N/A   |   N/A    |
+------------------------------------+---+----------+----------+------+----------+------+----------+----------+----------+

TEXTURE signals
===============

The texture_waits_for_shader signal depends of MP counters.

.. _texture-todo:
TODO
----

- find out how texture_sample_base_level_rate/texture_sample_average_level
  are computed

+--------------------------------------+----------+-----------------+----------------------+---------------------+
|                                      |   CTRL   |      EVENT      |         MPC          |         MUXS        |
+----------------------------------+---+----------+----------+------+--------------+-------+----------+----------+
| signal                           |SET| CTR_MODE |    SRC   |  OP  | PM_GROUP_SEL | UNK34 | 0x408508 | 0x40851c |
+==================================+===+==========+==========+======+==============+=======+==========+==========+
| texture_busy                     | 3 |  SIMPLE  |0x2c050402|0xeaea|  0x503c0201  |  0x1  |    N/A   |    N/A   |
+----------------------------------+---+----------+----------+------+--------------+-------+----------+----------+
| texture_waits_for_fb             | 2 |  SIMPLE  |0xcccccc3c|0xaaaa|      N/A     |  N/A  |set bit 11|set bit 11|
+----------------------------------+---+----------+----------+------+--------------+-------+----------+----------+
| texture_waits_for_shader         | 3 |  SIMPLE  |0x2c2c0100|0x2222|  0x503c0202  |  0x1  |    N/A   |    N/A   |
+----------------------------------+---+----------+----------+------+--------------+-------+----------+----------+
| texture_sample_base_level_rate_0 | 2 |  SIMPLE  |0x83828180|0x7fff|      N/A     |  N/A  |set bit 11|    N/A   |
+----------------------------------+---+----------+----------+------+--------------+-------+----------+----------+
| texture_sample_base_level_rate_1 | 2 |  SIMPLE  |0x83828180|0x0001|      N/A     |  N/A  |set bit 11|    N/A   |
+----------------------------------+---+----------+----------+------+--------------+-------+----------+----------+
| texture_sample_average_level_0   | 2 |  SIMPLE  |0x83828180|0x7fff|      N/A     |  N/A  |set bit 11|    N/A   |
+----------------------------------+---+----------+----------+------+--------------+-------+----------+----------+
| texture_sample_average_level_1   | 2 |  SIMPLE  |0x83828180|0x0001|      N/A     |  N/A  |set bit 11|    N/A   | 
+----------------------------------+---+----------+----------+------+--------------+-------+----------+----------+
